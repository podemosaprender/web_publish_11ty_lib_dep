
#U: P_REPOS_DIR=.. src/lib/bin/generate1 tesla UPDATE

SITE_ID=${1:-my-site}
GEN_REASON=$2

P_SITE_JSON_DIR=${P_SITE_JSON_DIR:-src/sites_json}
P_VAR_DIR=${P_VAR_DIR:-xvar}
P_REPOS_DIR=${P_REPOS_DIR:-xrepos}

BASE_DIR=`cd ${0%/*}/../../.. ; pwd`
GEN_DIR=$P_VAR_DIR/gen
echo "GENERATE1 P_VAR_DIR=$P_VAR_DIR P_SITE_JSON_DIR=$P_SITE_JSON_DIR P_REPOS_DIR=$P_REPOS_DIR BASE_DIR=$BASE_DIR"
mkdir -p $GEN_DIR/{files_json,files_3p,files_tpl,files_site,log}

files_lib_dir="$GEN_DIR/webtpl"
files_jsondef_name="$P_SITE_JSON_DIR/$SITE_ID.json"
files_jsondefHash_name="$GEN_DIR/files_json/${SITE_ID}.sha256"
files_jsonfiles_name="$GEN_DIR/files_json/$SITE_ID.json"
files_tpl_dir="$GEN_DIR/files_tpl/$SITE_ID"
files_site_dir="$GEN_DIR/files_site/$SITE_ID"
files_log_name="$GEN_DIR/log/$SITE_ID.log"

echo "GENERATE1 START `date`" > $files_log_name

if [ -f "$files_jsondef_name" ]; then
	jsonh256now=`cat $files_jsondef_name | sha256sum`	
	jsonh256before=`cat $files_jsondefHash_name 2>/dev/null`
	#DBG:echo "$jsonh256now"; echo "$jsonh256before"
fi

if [ -n "$GEN_REASON" ]; then true
elif [ "$jsonh256now" != "$jsonh256before" ]; then GEN_REASON="$SITE_ID json hash changed"
else echo "$SITE_ID SKIPPING, not changed" >> $files_log_name
fi

if [ -z "$GEN_REASON" ]; then	
	echo "GENERATE1 $SITE_ID no reason to generate, use the FORCE 2nd parameter">> $files_log_name
else
	echo "GENERATE1 $SITE_ID generate $GEN_REASON `date`" >> $files_log_name

	rm -Rf $files_lib_dir ; mkdir -p $files_lib_dir/base/src #XXX:CONCURRENCY
	cp -r $BASE_DIR/src/this_site/_* $BASE_DIR/src/this_site/l1b_ $files_lib_dir/base/src
	echo "COPIED BASE LIB FROM $BASE_DIR/this_site">> $files_log_name
	if [ -d $P_REPOS_DIR/webtpl ]; then
		git clone $P_REPOS_DIR/webtpl -b main $files_lib_dir/webtpl ; 
		echo "COPIED BASE LIB FROM $P_REPOS_DIR/webtpl">> $files_log_name
	fi

	rm -Rf $files_tpl_dir ; 
	if [ -d $P_REPOS_DIR/$SITE_ID ]; then
		git clone -b main $P_REPOS_DIR/$SITE_ID $files_tpl_dir >> $files_log_name 2>&1
		(cd $files_tpl_dir ; git log > __log__.txt)
	else
		echo "GENERATE1 no site repo found at $P_REPOS_DIR/$SITE_ID" >> $files_log_name 2>&1
		mkdir -p $files_tpl_dir
		(cd $files_tpl_dir ; date > __log__.txt)
	fi
	for x in webtpl base; do
		cp -v -r -n $files_lib_dir/$x/src/* $files_tpl_dir >> $files_log_name 2>&1 #A: no pisamos ej si edito _includes, el repo las tiene en src/
	done
	echo "COPIED BASE LIB to TPL_DIR $files_tpl_dir" >> $files_log_name 2>&1

	if [ -f $files_jsondef_name ]; then
		cat $files_jsondef_name | node src/lib/js/gen_site.js > $files_jsonfiles_name
		#A: json with file data generated
		cat $files_jsonfiles_name | node src/lib/js/json2file.js $files_tpl_dir
		#A: template files generated
		echo "COPIED JSON_DEF GENERATED BY $files_jsondef_name" >> $files_log_name 2>&1
	fi	

	export P_SITE_DIR=$files_tpl_dir
	export P_OUT_DIR=$files_site_dir
	export DBG=`cat $P_SITE_DIR/DBG 2>/dev/null`
	rm -rf $P_OUT_DIR ; mkdir -p $P_OUT_DIR
	echo "GENERATE1 BUILDING DBG=$DBG"  >> $files_log_name 2>&1
	if npm run build1 2>&1 | tee -a $files_log_name ; then
		echo "$jsonh256now" > $GEN_DIR/files_json/${SITE_ID}.sha256 #A: sha256 updated
		echo "GENERATE1 SITE GENERATED IN $P_OUT_DIR"  >> $files_log_name 2>&1
		if [ -d $P_SERVE_DIR ]; then
			echo "GENERATE1 COPY TO P_SERVE_DIR $P_SERVE_DIR/$SITE_ID" >> $files_log_name 2>&1
			if [ -d $files_site_dir/gen_site_root ]; then
				echo "GENERATE1 FOUND gen_site_root"  >> $files_log_name 2>&1
				find $files_site_dir/gen_site_root -type f -exec perl -pi -e 's/\/gen_site_root//g' {} \;
				mv $files_site_dir/gen_site_root/* $files_site_dir/
				rmdir $files_site_dir/gen_site_root
			fi
			rm -Rf $P_SERVE_DIR/$SITE_ID
			cp -r $files_site_dir $P_SERVE_DIR
		fi

		if [ -d ~/apps ]; then #A: hosting
			python3.12 $BASE_DIR/src/lib/bin/o-o-mk-redirect.py $SITE_ID
		fi

		exit 0
	else
		echo "GENERATE1 SITE GENERATED WITH ERRORS"  >> $files_log_name 2>&1
		exit 1
	fi
fi
